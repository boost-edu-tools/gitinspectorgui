# Auto-generated by scripts/switch-ci.sh. DO NOT EDIT.
# Base GitLab CI/CD configuration
# Contains common stages and variables

stages:
    - test
    - build
    - docs
    - deploy

variables:
    CARGO_HOME: $CI_PROJECT_DIR/.cargo
    CARGO_TARGET_DIR: $CI_PROJECT_DIR/target

.cache_template: &cache_template
    cache:
        key: ${CI_COMMIT_REF_SLUG}
        paths:
            - .cargo/
            - target/
            - node_modules/
            - python/.venv/

# The Docker image that will be used to build your app
image: node:lts

# Build the React application
build_app:
    stage: build
    before_script:
        - npm install -g pnpm
        - pnpm install
    script:
        - pnpm build
    artifacts:
        paths:
            - dist/
        expire_in: 1 hour
    rules:
        - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH

# Build documentation
build_docs:
    stage: build
    image: python:3.13-slim
    cache:
        key: mkdocs-deps
        paths:
            - .pip-cache/
    before_script:
        - pip install --cache-dir .pip-cache mkdocs mkdocs-material mkdocs-mermaid2-plugin
    script:
        - mkdocs build
    artifacts:
        paths:
            - site/
        expire_in: 1 hour
    rules:
        - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH

# Deploy to group pages (edu-boost.gitlab.io)
deploy_to_group_pages:
    stage: deploy
    dependencies:
        - build_app
        - build_docs
    image: alpine:latest
    before_script:
        - apk add --no-cache curl
    script:
        - echo "Deploying app and documentation to group pages..."
        - |
            if curl -f -X POST \
                -F token=$DOCS_TRIGGER_TOKEN \
                -F ref=main \
                "https://gitlab.com/api/v4/projects/edu-boost%2Fedu-boost.gitlab.io/trigger/pipeline"; then
                echo "Group pages deployment triggered successfully"
            else
                echo "Failed to trigger deployment, but continuing..."
            fi
    rules:
        - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
    allow_failure: true
