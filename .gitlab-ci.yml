# Auto-generated by scripts/switch-ci.sh. DO NOT EDIT.
# Base GitLab CI/CD configuration
# Contains common stages and variables

stages:
    - test
    - build
    - docs
    - deploy

variables:
    CARGO_HOME: $CI_PROJECT_DIR/.cargo
    CARGO_TARGET_DIR: $CI_PROJECT_DIR/target

.cache_template: &cache_template
    cache:
        key: ${CI_COMMIT_REF_SLUG}
        paths:
            - .cargo/
            - target/
            - node_modules/
            - python/.venv/

# The Docker image that will be used to build your app
image: node:lts

# Build the React application
build_app:
    stage: build
    before_script:
        - npm install -g pnpm
        - pnpm install
    script:
        - pnpm build
    artifacts:
        paths:
            - dist/
        expire_in: 1 hour
    rules:
        - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH

# Build documentation
build_docs:
    stage: build
    image: squidfunk/mkdocs-material:latest
    script:
        - pip install mkdocs-mermaid2-plugin
        - mkdocs build
    artifacts:
        paths:
            - site/
        expire_in: 1 hour
    rules:
        - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH

# Deploy to GitLab Pages
pages:
    stage: deploy
    dependencies:
        - build_app
        - build_docs
    script:
        - mkdir public
        # Copy React app to root
        - cp -r dist/* public/
        # Copy documentation to /docs subdirectory
        - mkdir -p public/docs
        - cp -r site/* public/docs/
    artifacts:
        paths:
            - public
    rules:
        - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH

# Trigger edu-boost.gitlab.io pipeline when documentation changes
trigger_docs_rebuild:
    stage: docs
    image: alpine:latest
    before_script:
        - apk add --no-cache curl
    script:
        - echo "Documentation changes detected, triggering group pages rebuild..."
        - |
            if curl -f -X POST \
                -F token=$DOCS_TRIGGER_TOKEN \
                -F ref=main \
                "https://gitlab.com/api/v4/projects/edu-boost%2Fedu-boost.gitlab.io/trigger/pipeline"; then
                echo "Group pages rebuild triggered successfully"
            else
                echo "Failed to trigger rebuild, but continuing..."
            fi
    rules:
        - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
          changes:
              - "docs/**/*"
    allow_failure: true
